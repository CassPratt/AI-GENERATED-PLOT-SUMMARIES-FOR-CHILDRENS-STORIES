<!-- Add Bootstrap CSS link -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8sh+WyIxLZ6fwFq/CiGGFmBh2VwwjCO5eb2A2z" crossorigin="anonymous">

<script>
    async function blockButtons() {
        // Disable the Generate Summary button
        document.getElementById('generateBtn').disabled = true;

        // Disable the Choose File input
        document.getElementById('selectedFileInput').disabled = true;

        // Clear event handlers to prevent duplication
        document.getElementById('selectedFileInput').onchange = null;
    }

    function resetForm() {
        // Enable the buttons and clear the file input
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('selectedFileInput').disabled = false;
        document.getElementById('fileForm').reset();

        // Clear the image preview
        //document.getElementById('imagePreview').src = "";
    }

    function previewImage() {
        // Get the selected file input
        var fileInput = document.getElementById('selectedFileInput');

        // Get the image preview element
        var imagePreview = document.getElementById('imagePreview');

        // Check if a file is selected
        if (fileInput.files && fileInput.files[0]) {
            var reader = new FileReader();

            // Set up the reader to load the selected image
            reader.onload = function (e) {
                // Update the image preview source
                imagePreview.src = e.target.result;

                // Store the base64 representation of the selected image in a hidden input
                document.getElementById('hiddenImageInput').value = e.target.result;
            };

            // Read the selected image as a data URL
            reader.readAsDataURL(fileInput.files[0]);
        }
    }

    async function submitForm() {
        // Get form data
        var formData = new FormData(document.getElementById('fileForm'));

        // Submit the form using Fetch API
        try {
            await blockButtons();
            const response = await fetch('/generate_summary', {
                method: 'POST',
                body: formData
            });
            const html = await response.text();

            // Update the page with the response
            document.getElementById('resultContainer').innerHTML = html;

            // Display the selected image again
            document.getElementById('imagePreview').src = document.getElementById('hiddenImageInput').value;

            // Reset the form after processing
            resetForm();
        } catch (error) {
            console.error('Error:', error);
        }
    }
</script>

<div class="container mt-5">
    <h1>Generate a Plot Summary for a Children's Story</h1>
    <form method="post" id="fileForm" enctype="multipart/form-data" onsubmit="submitForm(); return false;">
        <label for="selected_file">Selected File:</label>
        <input type="file" name="selected_file" accept=".jpg, .jpeg, .png" required id="selectedFileInput" onchange="previewImage()">
        <button type="submit" class="btn btn-primary" id="generateBtn">Generate Summary</button>
    </form>

    <div class="mt-3">
        <!-- Image preview element -->
        <img id="imagePreview" class="img-thumbnail" alt="Selected Image Preview" style="max-width: 200px; max-height: 200px;">
    </div>

    <!-- Hidden input to store base64 representation of selected image -->
    <input type="hidden" id="hiddenImageInput" name="hiddenImageInput">

    <div class="mt-3" id="resultContainer">
        {% if result %}
            <h2>Result:</h2>
            <div class="row">
                <div class="col-8">
                    <!-- Display captions in separate columns -->
                    <div>
                        <strong>Caption 1:</strong> {{ result['captions'][0] }}
                    </div>
                    <div>
                        <strong>Caption 2:</strong> {{ result['captions'][1] }}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Add Bootstrap JS and Popper.js scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js" integrity="sha384-eMNiNE4YgYx59H7eLCf45sa86d4D/N/Fe7IcGJcd5fjB4lHTtMzXEDDd3TR5TUmS" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8sh+WyIxLZ6fwFq/CiGGFmBh2VwwjCO5eb2A2z" crossorigin="anonymous"></script>
